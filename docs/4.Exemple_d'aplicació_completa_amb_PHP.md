# Exemple d'aplicació completa amb PHP

## Definició del projecte

En l'anàlisi, es defineix la funcionalitat de l'aplicació i les seues limitacions. S'indica les dades que es volen emmagatzemar i es realitze un esquema E/R per a la BBDD. Es definiran:

* Les pantalles que vorà l'usuari
* El fitxers que formaràn l'aplicació i com es pasaran els pràmetres entre ells.
* L'estructura de dades i com manipular-la.
* La base de dades.

Finalment, en la implementació, s'escriuen el fitxers de l'aplicació. 

L'aplicació serà la web de una distribuidora. Tindrem un magatzem central i tendes que fan comandes al magatzem.

## Anàlisi de requeriments

Es requerix realitzar una aplicació per al departament de comandes de la distribuidora d'una cadena de tendes xineses. Les tendes de la cadena utilitzaran l'aplicació per realitzar comandes de productes.
L'aplicació ha de permetre:
* Consultar les categories de productes.
* Consultar els productes.
* Afegir una o més unitats d'un producte a la comanda.
* Consultar la comanda i eliminar productes.
* Realitzar la comanda, actualitzan la base de dades i enviant correus de confirmació a la tenda que fa la comanda i a la central.

Per tal d'accedir a l'aplicació cal autenticar-se. 
De cada categoria es vol emmagatzemar el seu codi, nom, descripció. Dels productes, el seu codi,nom, descripció, quantitat en stock i la categoria a la que pertany. Cada producte pertany a una categoria.

De cada comanda interesa saber:

* La tenda que l'ha realitzat.
* Els productes que s'han demanat, incloent la quantitat.
* La data.
* Si s'ha remés.

Les comandes s'introduiran a la base de dades com a no enviats i el departament de comandes les marcarà com a envidades (l'aplicació no s'encarrega d'això).

De les tendes guardarem:

* El codi
* El correu electrònic.
* La clau
* Pais, adreça i codi postal.

### Esquema Entitat Relació


![Esquema](../img/ER.png)

### Limitacions de l'aplicació

* No hi ha panel d'administració. Els usuaris, categories i productes s'han d'introduir directament a la BBDD
* No hi ha possibilitat d'autoregistre.
* No es control·la l'stock.

## Disseny de l'aplicació

A partir de l'analisi anterior dissenyarem:

* La base de dades.
* El fluxe de pantalles per a realitzar una comanda.
* L'estructura de dades per a una comanda.
* Els fitxers de l'aplicació i com es passen paràmetres.
* El control d'accés.

### Disseny lògic de la BBDD

A partir de l'esquema anterior s'obtenen les següent taules:

Base de dades **Distribuidora**
Categories(**idcategoria**,nom,descripcio)
Comandes(**idComanda**,data,enviada,Tenda\_idTenda)
Inclou(**Comanda\_idComanda**,**Producte\_idProducte**,quantitat)
Productes(**idProducte**,nom,descripcio,stock,categoria_idcategoria)
Tendes(**idTenda**,correu,password,adreça,codiPostal,pais)

Per a passar al disseny físic de la BBDD cal decidir els tipus de dades de les columnes. Així marcarem els correus com a unics i les claus com a autoincrementables. 

### Diagrama de fluxe de pantalles

L'objectiu es representar les pantalles per les que pasa l'usuari al realitzar una operació. El següent diagrama pot ser una possible solució a aquest cas:

### La comanda

L'estructura de dades utilitzada per a una comanda és un dels punts més importants de l'aplicació. per a emmagatzemar-la utilitzarem una variable de sessió.

La comanda serà un array associatiatiu en els que les claus dels elements representen el codi del producte, y el valor, el número de unitats demanades.

L'array comença buïd. Quan s'afeguix un producte a la comanda, cal comprovar si ja hi ha en el array un element amb eixa clau. Si no l'afegueix. Si hi ha un element amb eixe codi, s'afegueixen les unitats al valor actual de l'element.

De la mateixa manera, a l'eliminar productes de la comanda, cal cercar l'element corresponent i restar-li les unitats.

### Control d'accés

Quan es realitza un login amb èxit, es crea una nova sessió i dos variables de sessió:

* Un array amb dos camps. Un per a guardar el nom de l'usuari i el seu codi.
* La variable per a la comanda.

La resta de fitxers de l'aplicació comencen unint-se a la sessió i comprovant que la primera d'estes variables existeix. En cas contrari, no pot accedir i es redirigueix a la pàgina de login.3

### Fitxers de l'aplicació
 
 El següent pas es decidir que fitxers formaràn part de l'aplicació i com es comuniquen entre si.
 
| Ruta | Descripció | Paràmetres | Adreçar-se a |
| -- | -- | -- | -- |
| login.php | Formulari de login | $_GET['redirigit'] $\_POST['usuari'] $\_POST['clau'] | login.php?error=TRUE categorias.php | 
| logout.php | Tanca la sessió | | |
| sessions.php | Comprova que l'usuari haja iniciat sessió correctament | | login.php (si no ha iniciat) |
| categories.php | Mostra la llista de categories amb vincles a productes.php?categoria=codigo | | |
| cabecera.php | capçalera amb vincles per a vore la comanda,les categories o tancar sessió | | | 
| pie.php | peu de pagina | | |
| productes.php |  mostra els productes de la categoria, permet afegir a la comanda | $\_GET['categoria'] | |
| comanda.php | mostra la comanda, permet llevar productes o confirmar-la | | |
| afegir.php | afegueix productes a la comanda | $\_POST['cod'] $\_POST['unitats'] | comanda.php |
| eliminar.php | elimina productes de la comanda |  $\_POST['cod'] $\_POST['unitats'] | comanda.php |
| processar.php | Insereix la comanda en la BBDD, envia correus de confirmació i mostra missatges d'exit o error | | |
| bd.php | classe per fer la connexio amb la BBDD | | |
| mail.php | classe per a enviar correus | | |
| consultes.php | fitxer amb funcions per fer consultes a la base de dades i relaciones amb les sessions | | |
 
 
### Implementació
  
#### configuració del lloc web
  
  Una vegada completat el disseny de l'aplicació, es pot començar en l'implementació. 
  Anem a crear un directori dins de Code que s'anomene **Distribuidora**.
  Entre a la màquina **homestead** i al directori /home/vagrant/Code/Distribuidora:
  
  * Creem el lloc web al ngnix
 
  ```
  serve distribuidora.my /home/vagrant/Code/Distribuidora/public
  ```
 
  * Ara instal.lem les dependències que ens faràn falta mitjançant composer:
  
  ```
  	composer require phpmailer/phpmailer
  	composer require --dev phpunit/phpunit
  	composer require filp/whoops
 	composer require twbs/bootstrap:4.3.1
  ```
  
 Anem a crear els següents directoris:
 
 * **clases** per a guardar les classes.
 * **public** on aniran els fitxers de l'aplicatiu.
 * **public/css** per a guardar els fitxers de css.
 * **public/js** per a guardar els fitxers de javascript.
 * **Helpers** on guardem els fitxers de funcions comunes.

 
 Com que a l'instal·lar el boostrap queda dins de la carpeta vendors anem a crear enllaços simbòlics des de les carpetes css i js als fitxers corresponents. Ho fem des del directori corresponent (public/css i public/js)
 
 ```
  ln -s /home/vagrant/Code/Distribuidora/vendor/twbs/bootstrap/dist/css/bootstrap.min.css
  ln -s /home/vagrant/Code/Distribuidora/vendor/twbs/bootstrap/dist/js/bootstrap.min.js
 
 ```
    
  Modifiquem el fitxer composer.json per a incloure el fitxer de funcions que s'anomenarà **consultes.php** i estarà dins de la carpeta Helpers. Aixì qualsevol funció que estiga dins d'eixe fitxer serà visible des de qualsevol fitxer que carregue el **/vendor/autoload.php**. 
  Al mateix temps farem que les classes penjen del namespace **/App** i que estiguen en el directori **clases** i així poder importar-les on calguen.
 Així afegim el següent codi:
 
 ```  
  "autoload": {
        "psr-4":{
            "App\\" : "clases/"
        },
        "files": [
            "Helpers/consultes.php"
        ]
    } 
 ```     
  
  Partint del disseny anterior es van implementant tots els fitxers:

config/database.php

```php
<?php
return [
    'ip' => '192.168.10.10',
    'nom' => 'Distribuidora',
    'usuari' => 'homestead',
    'clau' => 'secret'
]; 
```

config/load.php

```php
<?php
require dirname(__FILE__) . "/../vendor/autoload.php";
$whoops = new \Whoops\Run;
$whoops->pushHandler(new \Whoops\Handler\PrettyPageHandler);
$whoops->register();
```
  
clases/bd.php  

```php
namespace App;

class bd extends \PDO
{

    public function __construct()
    {
        $res = $this->leer_config();
        return parent::__construct($res[0], $res[1], $res[2]);
    }

    private function leer_config(){
        $config = require '../config/database.php';
        if (!$config){
            throw new InvalidArgumentException("Revise fichero de configuración");
        }
        $resul = [];
        $resul[] = sprintf("mysql:dbname=%s;host=%s", $config['nom'], $config['ip']);
        $resul[] = $config['usuari'];
        $resul[] = $config['clau'];
        return $resul;
    }

}
```  

clases/mail.php
 
```php 
<?php
namespace App;

use PHPMailer\PHPMailer\PHPMailer;

class mail
{
    private $carrito;
    private $pedido;
    private $correo;

    public function __construct($carrito,$pedido,$correo)
    {
        $this->carrito = $carrito;
        $this->pedido = $pedido;
        $this->correo = $correo;
    }

    public function enviar_correos(){
        $cuerpo = $this->crear_correo();
        return $this->enviar_correo_multiples("$this->correo, igomis@cipfpbatoi.es",
            $cuerpo, "Pedido $this->pedido confirmado");
    }

    private function crear_correo(){
        $texto = "<h1>Pedido nº $this->pedido </h1><h2>Restaurante: $this->correo </h2>";
        $texto .= "Detalle del pedido:";
        $productos = carregar_productes(array_keys($this->carrito));
        $texto .= "<table>"; //abrir la tabla
        $texto .= "<tr><th>Nombre</th><th>Descripción</th><th>Unidades</th></tr>";
        foreach($productos as $producto){
            $cod = $producto['idProducte'];
            $nom = $producto['nom'];
            $des = $producto['descripcio'];
            $unidades = $_SESSION['comanda'][$cod];
            $texto .= "<tr><td>$nom</td><td>$des</td><td>$unidades</td>
		<td> </tr>";
        }
        $texto .= "</table>";
        return $texto;
    }

    private function enviar_correo_multiples($lista_correos,  $cuerpo,  $asunto = ""){
        $mail = new PHPMailer();
        $mail->IsSMTP();
        $mail->SMTPDebug  = 0;  // cambiar a 1 o 2 para ver errores
        $mail->SMTPAuth   = true;
        $mail->SMTPSecure = "tls";
        $mail->Host       = "smtp.gmail.com";
        $mail->Port       = 587;
        $mail->Username   = "";  //usuario de gmail
        $mail->Password   = ""; //contraseña de gmail
        $mail->SetFrom('noreply@empresafalsa.com', 'Sistema de pedidos');
        $mail->Subject    = $asunto;
        $mail->MsgHTML($cuerpo);
        /*partir la lista de correos por la coma*/
        $correos = explode(",", $lista_correos);
        foreach($correos as $correo){
            $mail->AddAddress($correo, $correo);
        }
        if(!$mail->Send()) {
            return $mail->ErrorInfo;
        } else {
            return TRUE;
        }
    }
}
```  

Helpers/consultes.php

```php 
<?php


use App\bd;

function comprovar_usuari($nombre, $clave){
	$bd = new bd();
	$resul = $bd->query("SELECT idTenda, correu FROM Tendes WHERE correu = '$nombre' 
			AND password = '$clave'");
	if($resul->rowCount() === 1){
		return $resul->fetch();		
	}else{
		return FALSE;
	}
}
function carregar_categories(){
    $bd = new bd();
	$resul = $bd->query("select idcategoria, nom from Categories");
	if (!$resul) {
		return FALSE;
	}
	if ($resul->rowCount() === 0) {    
		return FALSE;
    }
	//si hay 1 o más
	return $resul;	
}
function carregar_categoria($codCat){
    $bd = new bd();
	$resul = $bd->query( "select nom, descripcio from Categories where idcategoria = $codCat");
	if (!$resul) {
		return FALSE;
	}
	if ($resul->rowCount() === 0) {    
		return FALSE;
    }	
	//si hay 1 o más
	return $resul->fetch();	
}
function carregar_productes_categoria($codCat){
    $bd = new bd();
	$resul = $bd->query("select * from Productes where categoria_idcategoria  = $codCat");
	if (!$resul) {
		return FALSE;
	}
	if ($resul->rowCount() === 0) {    
		return FALSE;
    }	
	//si hay 1 o más
	return $resul;			
}
// recibe un array de códigos de productos
// devuelve un cursor con los datos de esos productos
function carregar_productes($codigosProductos){
    $bd = new bd();
	$texto_in = implode(",", $codigosProductos);
	$resul = $bd->query( "select * from Productes where idProducte in($texto_in)");
	if (!$resul) {
		return FALSE;
	}
	return $resul;	
}
function insereix_comanda($carrito, $codTen){
    $bd = new bd();
	$bd->beginTransaction();	
	$hora = date("Y-m-d H:i:s", time());
	// insertar el pedido
	$sql = "insert into Comandes(data, enviada, Tenda_idTenda) 
			values('$hora',0, $codTen)";

	$resul = $bd->exec($sql);
	if (!$resul) {
		return FALSE;
	}
	// coger el id del nuevo pedido para las filas detalle
	$pedido = $bd->lastInsertId();
	// insertar las filas en pedidoproductos
	foreach($carrito as $codProd=>$unidades){
		$sql = "insert into Inclou(Comanda_idComanda, Producte_idProducte, quantitat) 
		             values( $pedido, $codProd, $unidades)";

		 $resul = $bd->exec($sql);
		if (!$resul) {
			$bd->rollback();
			return FALSE;
		}
	}
	$bd->commit();
	return $pedido;
}

function comprobar_sesion(){
    session_start();
    if(!isset($_SESSION['usuari'])){
        header("Location: login.php?redirigido=true");
    }
}
``` 

public/login.php

```php

require dirname(__FILE__) . "/../config/load.php";
/*formulario de login habitual
si va bien abre sesión, guarda el nombre de usuario y redirige a principal.php 
si va mal, mensaje de error */
if ($_SERVER["REQUEST_METHOD"] == "POST") {  
	
	$usu = comprovar_usuari($_POST['usuario'], $_POST['clave']);
	if($usu===false){
		$err = true;
		$usuario = $_POST['usuario'];
	}else{
		session_start();
		// $usu tiene campos correo y codRes, correo 
		$_SESSION['usuari'] = $usu;
		$_SESSION['comanda'] = [];
		header("Location: categories.php");
		return;
	}	
}
?>
<!DOCTYPE html>
<html>
	<head>
		<title>Formulario de login</title>
		<meta charset = "UTF-8">
	</head>
	<body>	
		<?php if(isset($_GET["redirigido"])){
			echo "<p>Haga login para continuar</p>";
		}?>
		<?php if(isset($err) and $err == true){
			echo "<p> Revise usuario y contraseña</p>";
		}?>
		<form action = "<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>" method = "POST">
			<label for = "usuario">Usuario</label> 
			<input value = "<?php if(isset($usuario))echo $usuario;?>"
			id = "usuario" name = "usuario" type = "text">		
			<label for = "clave">Clave</label> 
			<input id = "clave" name = "clave" type = "password">					
			<input type = "submit">
		</form>
	</body>
</html>
``` 

public/logout.php

```php 
<?php
	require dirname(__FILE__) . "/../config/load.php";
	comprobar_sesion();
	$_SESSION = array();
	session_destroy();	// eliminar la sesion
	setcookie(session_name(), 123, time() - 1000); // eliminar la cookie
?>

<!DOCTYPE html>
<html>
	<head>
		<meta charset = "UTF-8">
		<title>Sesión cerrada</title>
	</head>
	<body>
		<p>La sesión se cerró correctamente, hasta la próxima</p>
		<a href = "login.php">Ir a la página de login</a>
	</body>
</html>
``` 

public/cabecera.php

```php 
<?php
require dirname(__FILE__) . "/../config/load.php";
comprobar_sesion();
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset = "UTF-8">
    <title>Distribuidora</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header>
     Usuari: <?php echo $_SESSION['usuari']['correu']?>
     <a href="categories.php">Home</a>
     <a href="comanda.php">Vore comanda</a>
     <a href="logout.php">Tancar sesión</a>
    </header>
    <hr>
``` 
 
public/pie.php

```php 
</body>
<script type="text/javascript" src="/js/bootstrap.min.js"</script>
</html>
``` 

public/categories.php

```php 
<?php require 'cabecera.php';?>
<h1>Lista de categorías</h1>
<!--lista de vínculos con la forma
productos.php?categoria=1-->
<?php
$categorias = carregar_categories();
if($categorias===false){
    echo "<p class='error'>Error al connectar a la base de dades</p>";
}else{
    echo "<ul>"; //abrir la lista
    foreach($categorias as $cat){
        /*$cat['nombre] $cat['codCat']*/
        $url = "productes.php?categoria=".$cat['idcategoria'];
        echo "<li><a href='$url'>".$cat['nom']."</a></li>";
    }
    echo "</ul>";
}
?>
<?php require 'pie.php';?>
``` 

public/productes.php

```php 
<?php
    require 'cabecera.php';
    $cat = carregar_categoria($_GET['categoria']);
    $productos = carregar_productes_categoria($_GET['categoria']);
    if($cat=== FALSE or $productos === FALSE){
        echo "<p class='error'>Error al conectar con la base datos</p>";
        exit;
    }
    echo "<h1>". $cat['nom']. "</h1>";
    echo "<p>". $cat['descripcio']."</p>";
    echo "<table>"; //abrir la tabla
    echo "<tr><th>Nombre</th><th>Descripción</th><th>Stock</th><th>Comprar</th></tr>";
    foreach($productos as $producto){
        $cod = $producto['idProducte'];
        $nom = $producto['nom'];
        $des = $producto['descripcio'];
        $stock = $producto['stcok'];
        echo "<tr><td>$nom</td><td>$des</td><td>$stock</td>
        <td><form action = 'afegir.php' method = 'POST'>
        <input name = 'unidades' type='number' min = '1' value = '1'>
        <input type = 'submit' value='Comprar'><input name = 'cod' type='hidden' value = '$cod'>
        </form></td></tr>";
    }
    echo "</table>"
?>
<?php require 'pie.php';?>
``` 

public/afegir.php

```php 
<?php 
require dirname(__FILE__) . "/../config/load.php";
comprobar_sesion();
$cod = $_POST['cod'];
$unidades = (int)$_POST['unidades'];
/*si existe el código sumamos las unidades*/
if(isset($_SESSION['comanda'][$cod])){
	$_SESSION['comanda'][$cod] += $unidades;
}else{
	$_SESSION['comanda'][$cod] = $unidades;
}
header("Location: comanda.php");
``` 

public/eliminar.php

```php 
<?php 
require dirname(__FILE__) . "/../config/load.php";
comprobar_sesion();
$cod = $_POST['cod'];
$unidades = $_POST['unidades'];
/*si existe el código restamos las unidades, con mínimo de 0*/
if(isset($_SESSION['comanda'][$cod])){
	$_SESSION['comanda'][$cod] -= $unidades;
	if($_SESSION['comanda'][$cod] <= 0){
		unset($_SESSION['comanda'][$cod]);
	}
	
}
header("Location: comanda.php");
``` 

public/comanda.php

```php 
<?php
require 'cabecera.php';
$productos = carregar_productes(array_keys($_SESSION['comanda']));
if($productos === FALSE){
    echo "<p>No hi ha productes a la comanda</p>";
    exit;
}
echo "<h2>Comanda</h2>";
echo "<table>"; //abrir la tabla
echo "<tr><th>Nombre</th><th>Descripción</th><th>Unidades</th><th>Eliminar</th></tr>";
foreach($productos as $producto){
    $cod = $producto['idProducte'];
    $nom = $producto['nom'];
    $des = $producto['descripcio'];
    $unidades = $_SESSION['comanda'][$cod];

    //print_r($producto);
    echo "<tr><td>$nom</td><td>$des</td><td>$unidades</td>
    <td><form action = 'eliminar.php' method = 'POST'>
    <input name = 'unidades' type='number' min = '1' value = '1'>
    <input type = 'submit' value='Eliminar'>
    <input name = 'cod' type='hidden' value = '$cod'>  </form></td></tr>";
}
echo "</table>";
?>
<hr>
<a href = "processar.php">Realitzar Comanda</a>
<?php require 'pie.php';?>
``` 

public/processar.php

```php 
<?php
	/*comprueba que el usuario haya abierto sesión o redirige*/
	use App\mail;
	require 'cabecera.php';
	$resul = insereix_comanda($_SESSION['comanda'], $_SESSION['usuari']['idTenda']);
	if($resul === FALSE){
		echo "No s'ha pogut realitzar la comanda<br>";
	}else{
		$correo = $_SESSION['usuari']['correu'];
		echo "Comanda realitzada amb èxit. Se enviarà un correu de confirmació a: $correo ";
		$mail = new mail($_SESSION['comanda'], $resul, $correo);
        $resul =$mail->enviar_correos();
		if($resul !==TRUE){
			echo "Error a l'enviar: $resul <br>";
		};		
		//vaciar carrito	
		$_SESSION['comanda'] = [];

    }
	?>
<?php require 'pie.php';?>
``` 

Ha arribat el moment de completar la web amb uns exericisis:
[Exercisi 4.1 Aplicació](4.1.Activitat.md)



Amb tot açó tendriem una primera versió de la web. Però tenim algunes deficiències importants:

* 





